import streamlit as st
import requests
import json
from datetime import datetime

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
st.set_page_config(page_title="Secured Inspection Audit", page_icon="ğŸ›¡ï¸", layout="centered")

# ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ Ù„Ø¬Ø¹Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ´Ø¨Ù‡ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ù…Ù†Ø§Ø³Ø¨ Ù„Ø¬Ù‡Ø§Ø² iPhone 16 Pro Max)
st.markdown("""
    <style>
    .main { background-color: #f8f9fa; }
    .stButton>button { 
        width: 100%; 
        border-radius: 20px; 
        height: 3.5em; 
        font-weight: 900; 
        font-size: 18px;
        text-transform: uppercase;
    }
    .stTextInput>div>div>input { border-radius: 12px; }
    </style>
    """, unsafe_allow_html=True)

# Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†
st.title("ğŸ›¡ï¸ Secured Logistics Audit")
st.write("Dubai Airport Free Zone | UAE")

# --- [1. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„] ---
st.info("ğŸ“‹ Report Header Information")
col1, col2 = st.columns(2)
with col1:
    customer_code = st.text_input("Customer Code", placeholder="C-000")
    start_time = st.time_input("Start Time")
with col2:
    company_name = st.text_input("Company Name", placeholder="Client Name")
    end_time = st.time_input("End Time")

# --- [2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª] ---
st.divider()
st.subheader("ğŸ“¦ Inventory Items")

if 'items' not in st.session_state:
    st.session_state.items = []

def add_item():
    st.session_state.items.append({"model": "", "gb": "", "color": "", "pcs": 1, "spec": ""})

if st.button("â• Add New Device Entry"):
    add_item()

# Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©
for i, item in enumerate(st.session_state.items):
    with st.expander(f"Device #{i+1}: {item['model'] if item['model'] else 'New Entry'}", expanded=True):
        item['model'] = st.text_input(f"Manufacturer & Model", key=f"model_{i}", placeholder="e.g. iPhone 16 Pro Max")
        
        c1, c2, c3 = st.columns([1, 1, 1])
        item['gb'] = c1.text_input(f"RAM/GB", key=f"gb_{i}", placeholder="256GB")
        item['color'] = c2.text_input(f"Color", key=f"color_{i}", placeholder="Desert Titanium")
        item['pcs'] = c3.number_input(f"Qty (Pcs)", min_value=1, key=f"qty_{i}")
        
        item['spec'] = st.text_input(f"SPEC / Part Number", key=f"spec_{i}", placeholder="Model/Region Code")

# --- [3. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ²Ø± Ø§Ù„Ø­ÙØ¸] ---
if st.session_state.items:
    total_qty = sum(int(item['pcs']) for item in st.session_state.items)
    st.metric("Total Units Audited", f"{total_qty} Pcs")

    st.divider()
    if st.button("ğŸš€ SAVE TO GOOGLE DRIVE", type="primary"):
        with st.spinner("Uploading to Secured Cloud..."):
            # Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Web App URL)
            SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNArqZNDcvfqT33xCN17P9ShVMFS6VWajmWJcLv1yBNHt7zoqNVkTahHJIl6GNs6yYvg/exec"
            
            payload = {
                "header": {
                    "customerCode": customer_code,
                    "companyName": company_name,
                    "startTime": str(start_time),
                    "endTime": str(end_time),
                    "checkedBy": "Auditor"
                },
                "items": st.session_state.items,
                "totalQty": total_qty,
                "deviceInfo": "iPhone 16 Pro Max 256GB, Desert Titanium, China"
            }
            
            try:
                # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù€ Apps Script
                response = requests.post(SCRIPT_URL, data=json.dumps(payload))
                st.success("âœ… Successfully Synchronized with Google Drive!")
                st.balloons()
            except:
                st.warning("âš ï¸ Data sent! Check your Drive folder.")